package roomescape.reservation.infrastructure.fake;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import roomescape.reservation.application.dto.CreateReservationRequest;
import roomescape.reservation.application.repository.ReservationRepository;
import roomescape.reservation.domain.Reservation;

public class FakeReservationDao implements ReservationRepository {

    private Long autoGeneratedId = 0L;
    private final Map<Long, Reservation> store = new HashMap<>();

    @Override
    public Reservation insert(CreateReservationRequest request) {
        autoGeneratedId++;
        Reservation reservation = new Reservation(autoGeneratedId,
                request.name(),
                request.theme(),
                request.date(),
                request.time()
        );
        store.put(autoGeneratedId, reservation);

        return reservation;
    }

    @Override
    public List<Reservation> findAllReservations() {
        return store.values().stream().toList();
    }

    @Override
    public int delete(Long reservationId) {
        if (!store.containsKey(reservationId)) {
            return 0;
        }

        store.remove(reservationId);
        return 1;
    }

    @Override
    public boolean existsByTimeId(Long timeId) {
        return store.values().stream()
                .anyMatch(reservation -> reservation.getReservationTime().getId().equals(timeId));
    }

    @Override
    public boolean existsByDateTime(LocalDateTime reservationDateTime) {
        return store.values().stream()
                .anyMatch(reservation -> {
                    LocalTime time = reservation.getReservationTime().getStartAt();
                    LocalDate date = reservation.getDate().getReservationDate();
                    return LocalDateTime.of(date, time).equals(reservationDateTime);
                });
    }

    @Override
    public boolean existsByThemeId(Long themeId) {
        return store.values().stream()
                .anyMatch(reservation -> reservation.getTheme().getId().equals(themeId));
    }

    @Override
    public List<Long> findBookedTimeIds(LocalDate date, Long themeId) {
        return store.values().stream()
                .filter(reservation ->
                        reservation.getDate().getReservationDate().equals(date) &&
                                reservation.getTheme().getId().equals(themeId))
                .map(reservation -> reservation.getReservationTime().getId())
                .toList();
    }
}
